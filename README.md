# NXP_2025 项目 README

## 项目简介
本项目是为智能车竞赛设计的代码仓库，主要功能包括：
- 圆环元素识别与处理
- PID 控制算法实现
- IMU 姿态解算（四元数更新、互补滤波）
- 卡尔曼滤波参数调优
- CCD 图像处理与路径识别
- 电机控制与转向逻辑

项目基于 NXP 的 RT1064 微控制器开发，包含大量嵌入式底层驱动和算法实现，适用于智能车的路径识别、姿态控制、传感器融合等场景。

## 主要功能模块

### 1. 圆环识别与处理
- **预判**：通过远端 CCD 赛宽变化判断是否接近圆环。
- **确认**：检测远端 CCD 赛宽变化趋势，确认是否进入圆环。
- **入环**：根据误差累积调整车辆路径，使其顺利进入圆环。
- **出环判断**：通过远端 CCD 右侧边界丢失和赛宽变化判断是否到达圆环出口。
- **出环**：根据累计误差调整车辆方向，使其平稳驶出圆环。
- **状态清零**：当远端和近端 CCD 赛宽恢复正常后，清零圆环状态。

### 2. PID 控制系统
- **角速度环（PI 控制）**：用于控制车辆的平衡，消除陀螺仪漂移。
- **角度环（PD 控制）**：用于姿态调节，提高响应速度和稳定性。
- **速度环（P 控制）**：控制车辆前进速度，避免积分饱和导致的不稳定。

#### 控制流程
```text
主循环（motor_control）：
├─ 每50次执行速度环（输出→角度环输入）
├─ 每5次执行角度环（输出→角速度环输入）
├─ 实时执行角速度环（输出→电机）
├─ 转向控制（dir_control）：
   ├─ 每2次执行摄像头反馈（外环PD）
   └─ 实时执行陀螺仪反馈（内环PI）
最终电机输出 = 角速度环输出 ± 转向控制输出
```

### 3. IMU 姿态解算（quaternion.c）
- **初始化与校准**：陀螺仪和加速度计零偏校准。
- **数据处理**：低通滤波、单位转换。
- **姿态解算**：使用互补滤波算法，结合加速度计和陀螺仪数据。
- **四元数更新**：采用一阶龙格库塔法进行积分。
- **欧拉角计算**：从四元数导出俯仰角、横滚角、偏航角。

### 4. 卡尔曼滤波
- **预测 + 更新**：结合系统模型和传感器测量值，得到更准确的状态估计。
- **调参建议**：
  - `Q`：过程噪声（模型误差）
  - `R`：测量噪声（传感器误差）
  - `P`：初始状态协方差
- **调参技巧**：
  - Q/R 比值决定滤波器对模型和测量的信任程度。
  - 初始 P 设为较大值，加快收敛。
  - 动态调整 Q/R 比值以适应不同运动状态。

### 5. CCD 图像处理
- **阈值处理**：动态调整 CCD 图像的黑白阈值。
- **中点检测**：根据 CCD 数据计算路径中点。
- **边界搜索**：识别路径边界，用于路径识别。
- **状态机处理**：通过状态机判断路径状态（如入环、出环、斑马线等）。
- **误差计算**：用于转向控制的路径偏差。

### 6. 电机与转向控制
- **差速控制**：通过左右电机差速实现转向。
- **串级 PID**：
  - 外环（摄像头）：PD 控制，生成期望角速度。
  - 内环（陀螺仪）：PI 控制，匹配实际角速度。
- **限幅保护**：防止电机输出过大导致失控。

## 使用说明

### 1. 环境准备
- 开发环境：支持 C/C++ 的嵌入式开发环境（如 Keil、IAR、MCUXpresso）
- 硬件平台：NXP RT1064 开发板
- 传感器：陀螺仪、加速度计、CCD 摄像头、电机驱动模块

### 2. 编译与烧录
- 使用 IDE 打开项目，编译后烧录到 RT1064 开发板。
- 确保 `system_MIMXRT1064.c` 中的系统时钟配置正确。
- 配置 `fsl_clock.c` 中的时钟源和频率。

### 3. 参数调优
- **角速度环**：先调 I 消除静差，再调 P 提高响应。
- **角度环**：P 控制姿态调节，D 控制振荡抑制。
- **速度环**：P 控制加速响应，避免过大导致“点头”现象。
- **转向控制**：
  - 外环（摄像头）：增大 kp 加快路径回归，kd 抑制超调。
  - 内环（陀螺仪）：增大 kp 提高角速度跟踪速度，ki 消除稳态误差。

### 4. 调试工具
- 使用上位机查看 CCD 图像、陀螺仪数据、路径偏差等。
- 通过 `uart.py` 实现串口通信，用于调试信息输出。
- 使用 `menutext.py` 实现菜单式调试界面，方便参数调整。

## 代码结构说明

### 核心模块
- `user_main.py`：主控制逻辑，包含 PID 控制、IMU 更新、转向控制等。
- `ccd_handler.py`：CCD 图像处理，包含路径识别、边界搜索、状态机逻辑。
- `basic_data.py`：基础数据结构与工具函数（如 PID 控制器、限幅函数等）。
- `uart.py`：串口通信模块，用于调试与数据传输。
- `quaternion.c`：IMU 姿态解算核心代码。
- `kalman_filter.py`：卡尔曼滤波实现，用于传感器融合。

### 控制逻辑
- `dir_control`：转向控制主函数，包含摄像头外环和陀螺仪内环。
- `dir_out_ring`：外环 PD 控制，计算期望角速度。
- `dir_in_ring`：内环 PI 控制，计算最终转向差速。
- `motor_control`：主循环，协调速度环、角度环、角速度环和转向控制。

## 调车方法

### 1. 角速度环调优
- **调 I**：消除陀螺仪静差，使车能勉强立住。
- **调 P**：减小低频抖动，逐步增加 P 直至高频抖动出现，再适当减小。

### 2. 角度环调优
- **调 P**：使车具备自动调节能力。
- **调 D**：抑制振荡，提高稳定性。
- **适当降低角速度环参数**：避免角度环响应过慢。

### 3. 速度环调优
- **调 P**：控制加速响应，避免“点头”现象。
- **避免使用 I**：容易导致积分饱和，除非做好限幅和清零机制。

## 注意事项
- **传感器同步**：确保加速度计和陀螺仪数据在同一时间戳采集。
- **数值稳定性**：四元数归一化、PID 输出限幅、积分抗饱和。
- **实时性优化**：在资源受限的嵌入式系统中，避免复杂运算。
- **磁力计融合**：当前偏航角存在漂移，建议加入磁力计数据进行修正。

## 调试建议
- 使用 `MenuText` 类实现菜单式调试界面。
- 通过 `TickerProfiler` 检测函数执行频率。
- 使用 `Beeper` 类实现蜂鸣器报警，辅助调试状态识别。

## 项目贡献
- 本项目基于青山教授的智能车比赛经验分享，结合实际代码实现圆环识别、PID 控制、IMU 姿态解算等功能。
- 代码结构清晰，模块化设计，便于扩展与维护。
- 提供完整的调车方法与调参建议，适合初学者快速上手。

## 版权声明
本项目基于 MIT 许可证开源，欢迎自由使用与修改。请保留原始作者信息。

## 联系方式
如有问题或建议，请提交 Issue 或 Pull Request。

---

**祝你在智能车比赛中取得好成绩！** 🏁

<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=115124484447152&bvid=BV1DjajztELk&cid=32079151369&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>